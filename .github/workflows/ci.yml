name: CI

# Trigger
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Jobs
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ "3.10", "3.11" ]

    steps:
      # --- Checkout Repo ---
      - name: Checkout code
        uses: actions/checkout@v3

      # --- Setup Python ---
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      # --- Upgrade pip ---
      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      # --- Install PyTorch (CPU for CI) ---
      - name: Install PyTorch
        run: |
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

      # --- Install Requirements ---
      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # --- Install SSN in Editable Mode (NO BUILD ISOLATION) ---
      - name: Install package in editable mode
        run: |
          pip install -e . --no-build-isolation

      # --- Lint with Black ---
      - name: Lint with Black
        run: black --check .

      # --- Type Check with mypy (skip fail) ---
      - name: Type check with mypy
        run: mypy ssn/ || true

      # --- Run Tests with Coverage ---
      - name: Run tests with coverage
        run: |
          pytest tests/ --cov=ssn --cov-report=xml --cov-report=term-missing -v
          coverage report --fail-under=95

      # --- Run Benchmark Smoke Test (skip fail) ---
      - name: Run benchmark smoke test
        run: python benchmark/run_all.py || true

      # --- Build Docs (optional) ---
      - name: Build documentation
        run: |
          pip install sphinx
          cd docs && sphinx-build -b html . _build || true
